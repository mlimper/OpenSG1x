#!/bin/sh

# script to create an index page for the dailybuild log directory


# helper functions

# take the Main filename and split the info out of it

split_name ()
{
    name=$1
    
    year=`echo $name | cut -c19-20`
    month=`echo $name | cut -c21-22`
    day=`echo $name | cut -c23-24`
    hour=`echo $name | cut -c25-26`
    minute=`echo $name | cut -c27-28`
    
    system=`echo $name | sed -e 's|\.[a-zA-Z]*.html$||' | cut -c 30-`
}


# main script starts here

logdir=$1

if test ! -d $logdir -o ! -w $logdir 
then
    echo "$logdir not a directory or not writable, make_index aborted!"
    exit 1
fi

outfile=index.html

cd $logdir

# HTML header
cat << EOF > $outfile
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd"><html>
<html>
<head>
<title>OpenSG dailybuilds log index</title>
<style type="text/css">
<!--
body	    	{ background-color:#ffffff }
td.date		{ text-align:left; vertical-align:top }
td.system	{ text-align:left; vertical-align:top }
td.status	{ text-align:left; vertical-align:top }
td.source    	{ text-align:left; vertical-align:top }
td.snap	    	{ text-align:left; vertical-align:top }
//-->
</style>
</head>
<body>
<h1>OpenSG dailybuilds log index</h1>
<p>
<table border=1>
<tr>
<td><center>Date</center></td><td>System</td>
<td colspan=2><center>Snapshots</center></td><td>Status</td>
</tr>
EOF

lastdate="00.00.00"

for i in *.Main.html ;
do

    split_name $i
    
    echo "<tr>" >> $outfile
    date=$day.$month.$year
    if test $date != $lastdate
    then
    	echo "<td style=date>$date</td>" >> $outfile
	lastdate=$date
    else
    	echo "<td style=date> </td>" >> $outfile
    fi
    echo "<td style=system><a href=$i>$system</a></td>" >> $outfile

    snap=`echo $i | sed -e 's|Main.html|source.tgz|'`    
    if test -f $snap
    then
    	echo "<td style=source><a href=$snap>Src</a></td>" >> $outfile
    else
    	echo "<td style=source> </td>" >> $outfile
    fi

    snap=`echo $i | sed -e 's|Main.html|snapshot.tgz|'`    
    if test -f $snap
    then
    	echo "<td style=snap><a href=$snap>Lib</a></td>" >> $outfile
    else
    	echo "<td style=snap> </td>" >> $outfile
    fi
 
    status=`fgrep "had errors" $i | cut -c32- | sed -e 's|</font><br>||'`
    
    echo "<td style=status>$status</td>" >> $outfile
   
    echo "</tr>" >> $outfile

done




# HTML footer
cat << EOF >> $outfile
</table>
</body>
</html>
EOF
