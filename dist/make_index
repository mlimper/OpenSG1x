#!/bin/sh

# script to create an index page for the dailybuild log directory
# the script expects a index_skeleton.html file to insert itself into,
# by replacing the ##DAILYBUILD_LOGS## text.

# helper functions

# take the Main filename and split the info out of it

split_name ()
{
    name=$1
    
    year=`echo $name | cut -c19-20`
    month=`echo $name | cut -c21-22`
    day=`echo $name | cut -c23-24`
    hour=`echo $name | cut -c25-26`
    minute=`echo $name | cut -c27-28`
    
    system=`echo $name | sed -e 's|\.[a-zA-Z]*.html$||' | cut -c 30-`
}


# main script starts here

logdir=$1
skeleton=$2
target=$3



if test ! -d $logdir -o ! -w $logdir 
then
    echo "$logdir not a directory or not writable, make_index aborted!"
    exit 1
fi

cd $logdir

if test ! -r $skeleton 
then
    echo "$skeleton not readable, make_index aborted!"
    exit 1
fi

outfile=index_raw.html

# HTML header
cat << EOF > $outfile
<table border=1>
<tr>
<td><center>Date</center></td><td>System</td>
<td colspan=2><center>Snapshots</center></td><td>Status</td>
</tr>
EOF

lastdate="00.00.00"

for i in *.Main.html ;
do

    split_name $i
    
    echo "<tr>" >> $outfile
    date=$day.$month.$year
    if test $date != $lastdate
    then
    	echo "<td style=date>$date</td>" >> $outfile
	lastdate=$date
    else
    	echo "<td style=date> </td>" >> $outfile
    fi
    echo "<td style=system><a href=$i>$system</a></td>" >> $outfile

    snap=`echo $i | sed -e 's|Main.html|source.tgz|'`    
    if test -f $snap
    then
    	echo "<td style=source><a href=$snap>Src</a></td>" >> $outfile
    else
    	echo "<td style=source> </td>" >> $outfile
    fi

    snap=`echo $i | sed -e 's|Main.html|snapshot.tgz|'`    
    if test -f $snap
    then
    	echo "<td style=snap><a href=$snap>Lib</a></td>" >> $outfile
    else
    	echo "<td style=snap> </td>" >> $outfile
    fi
 
    status=`fgrep "had errors" $i | cut -c32- | sed -e 's|</font><br>||'`
    
    echo "<td style=status>$status</td>" >> $outfile
   
    echo "</tr>" >> $outfile

done

# HTML footer
cat << EOF >> $outfile
</table>
EOF

# merge with index_skeleton.html

sed -e '/DAILYBUILD_LOGS/r index_raw.html' \
	-e '/DAILYBUILD_LOGS/d' < $skeleton > $target

# remove temporary

rm index_raw.html
